<ng-template #darView>
    <div class="row mb-2">
        <div class="col-md-6">
            <label for="organisation" class="view-sub-sub-title">Requesting organisation</label>
            <h6 class="text-value">{{dar?.organisation?.defaultName}}</h6>
            <h6 class="text-value">{{dar?.organisationAddress}}</h6>
        </div>
        <div class="col-md-6">
            <label for="organisation" class="view-sub-sub-title">Principal secondary user</label>
            <h6 class="text-value">{{dar?.principalSecondaryUser?.firstName}} {{dar?.principalSecondaryUser?.lastName}}</h6>
            <h6 class="text-value">{{dar?.principalSecondaryUser?.email}}</h6>
            <h6 class="text-value">CV: see email</h6>
        </div>
    </div>
    <div class="row section-title">
        <div class="col-md-12 text-left">
            <div class="text-value" class="view-sub-sub-title">Additional secondary users</div>
        </div>
    </div>
    <ng-container *ngIf="dar?.additionalSecondaryUsers?.length > 0; else displaySecondaryUsers">
        <div class="row">
            <div class="col-md-12 text-left">
                <ul>
                    <li *ngFor="let additionalSecondaryUser of dar?.additionalSecondaryUsers">
                        <h6 class="text-value">{{additionalSecondaryUser?.firstName}} {{additionalSecondaryUser?.lastName}} ({{additionalSecondaryUser?.email}})</h6>
                    </li>
                </ul>
            </div>
        </div>
    </ng-container>
    <ng-template #displaySecondaryUsers>
        <div class="row">
            <div class="col-md-12">
                <h6 class="text-value">No other secondary users</h6>
            </div>
        </div>
    </ng-template>
    <div class="row section-title mt-7">
        <div class="col-md-12 text-left">
            <div class="text-value" class="view-sub-sub-title">Requested study for secondary use</div>
        </div>
    </div>
    <div class="row mt-2">
        <div class="col-md-12">
            <h6 class="text-value"><a [routerLink]="['/studies', dar?.requestedStudy?.sdSid, 'view']">{{dar?.requestedStudy?.sdSid}} - {{dar?.requestedStudy?.displayTitle}}</a></h6>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <ul class="mb-0">
                <ng-container *ngFor="let do of dar?.requestedStudy?.linkedObjects">
                    <li *ngIf="do.accessType?.name.toLowerCase() === 'controlled'">
                        <span class="li-text-2"><a [routerLink]="['/data-objects', do.sdOid, 'view']">{{do.sdOid}}</a>&nbsp;-&nbsp;{{do.displayTitle}}</span>
                    </li>
                </ng-container>
            </ul>
        </div>
    </div>
    <div class="row section-title mt-7">
        <div class="col-md-12 text-left">
            <div class="text-value" class="view-sub-sub-title">Secondary use project</div>
        </div>
    </div>
    <div class="row mt-2">
        <div class="col-md-12">
            <div class="font-style">Title</div>
            <h6 class="text-value">{{dar?.projectTitle}}</h6>
        </div>
    </div>
    <div class="row mt-2">
        <div class="col-md-12">
            <div class="font-style">Type</div>
            <h6 class="text-value">{{dar?.projectType}}</h6>
        </div>
    </div>
    <div class="row mt-2">
        <div class="col-md-12">
            <div class="font-style">Abstract/summary</div>
            <h6 class="text-value">{{dar?.projectAbstract}}</h6>
        </div>
    </div>
    <div class="row mt-2">
        <div class="col-md-12">
            <div class="font-style">Ethics approval</div>
            <h6 class="text-value">{{dar?.ethicsApproval}}, details: {{dar?.ethicsApprovalDetails}}</h6>
        </div>
    </div>
    <div class="row mt-2">
        <div class="col-md-12">
            <div class="font-style">Funding</div>
            <h6 class="text-value">{{dar?.projectFunding ? dar.projectFunding : 'No funding info'}}</h6>
        </div>
    </div>
    <div class="row mt-2">
        <div class="col-md-6">
            <div class="font-style">Estimated access duration required</div>
            <h6 class="text-value">{{dar?.estimatedAccessDurationRequired ? dar.estimatedAccessDurationRequired : 'No duration specified'}}</h6>
        </div>
        <div class="col-md-6">
            <div class="font-style">Provisional starting date</div>
            <h6 class="text-value">{{dar?.provisionalStartingDate ? dar.provisionalStartingDate : 'No provisional starting date specified'}}</h6>
        </div>
    </div>
    <div class="row section-title mt-7">
        <div class="col-md-12 text-left">
            <div class="text-value" class="view-sub-sub-title">Other information</div>
        </div>
    </div>
    <div class="row mt-2">
        <div class="col-md-12">
            <h6 class="text-value">{{dar?.otherInfo ? dar.otherInfo : 'No other info'}}</h6>
        </div>
    </div>
</ng-template>

<div class="card">
    <div class="card-header">
        <div [ngClass]="sticky ? '' : ''"  id="navbar">
            <div class="row upsert-navbar">
                <div class="col-md-3">
                    <h2>{{ isView ? ' Data Use Process' : isEdit ? 'Editing Data Use Process' : 'Adding new data use process'}}</h2>
                </div>
                <div class="col-md-9 text-right">
                    <ng-container *ngIf="!requestApproved; else dupButtons">
                        <ng-container *ngIf="hasDataAccessRequest && isManager">
                            <ng-container *ngIf="!(requestApproved || requestDenied); else requestDeniedButtons">
                                <button class="btn btn-success ml-2" (click)="approveRequest()">
                                    <i class="fa fa-circle-check"></i> Approve request
                                </button>
                                <button class="btn btn-danger ml-2" (click)="denyRequest()">
                                    <i class="fa fa-circle-xmark"></i> Deny request
                                </button>
                            </ng-container>
                            <ng-template #requestDeniedButtons>
                                <button class="btn btn-primary ml-2" (click)="resetRequestDecision()" 
                                    *ngIf="hasDataAccessRequest && (requestApproved || requestDenied)">
                                    <i class="fa fa-rotate"></i> Reset request decision
                                </button>
                            </ng-template>
                        </ng-container>
                    </ng-container>
                    <ng-template #dupButtons>
                        <ng-container *ngIf="isManager">
                            <button class="btn btn-primary ml-2" (click)="resetRequestDecision()" 
                                *ngIf="hasDataAccessRequest && !processAborted">
                                <i class="fa fa-rotate"></i> Reset request decision
                            </button>
                            <button class="btn btn-danger ml-2" (click)="abortProcess()" *ngIf="!processAborted">
                                <i class="fa fa-circle-xmark"></i> Abort process
                            </button>
                            <button class="btn btn-primary ml-2" (click)="unabortProcess()" *ngIf="processAborted">
                                <i class="fa fa-rotate-left"></i> Unabort process
                            </button>
                            <a [routerLink]="['/data-use', id, 'edit']" class="btn btn-primary ml-2" *ngIf="isView">
                                <i class="fa fa-edit"></i> Edit
                            </a>
                        </ng-container>
                        <button class="btn btn-primary ml-2" (click)="printDocument()">
                            <i class="fa fa-print"></i> PDF
                        </button>
                        <button class="btn btn-primary ml-2" (click)="jsonExport()">
                            <i class="fa fa-code"></i> JSON
                        </button>
                    </ng-template>
                    <button class="btn btn-success ml-2" (click)="onSave()" *ngIf="!isView">{{isEdit ? 'Apply Changes' : 'Save'}}</button>
                    <button class="btn btn-warning ml-2" (click)="back()">{{isView ? 'Back' : 'Cancel'}}</button>
                </div>
            </div>
            <div class="row mt-7">
                <div class="pl-5 d-inline-flex align-items-center">
                    <h4 class="mb-0 mr-4">{{dupData?.displayName}}</h4><span *ngIf="requestDenied" class="tag danger-tag">Request denied on {{ngbDateStructToString(fv.requestDecisionDate)}}</span>
                </div>
            </div>
        </div>
    </div>
    <div id="permanentNavbar"></div>
    <div class="card-body" [ngClass]="{'opacity-50': requestDenied || processAborted}">
        <ng-container *ngIf="hasDataAccessRequest && !requestApproved; else dupView">
            <ng-container *ngTemplateOutlet="darView"></ng-container>
        </ng-container>
        <ng-template #dupView>
            <div class="row">
                <div class="col-md-12 mb-5">
                    <ng-container *ngIf="isView || isEdit">
                        <ul class="nav nav-pills maxw-fit-content nav-fill" style="border-bottom: 1px solid lightgray">
                            <li class="nav-item">
                                <a class="nav-link active" href="#overview" data-toggle="tab" id="overviews">Overview</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#setup" data-toggle="tab" id="setups">
                                    {{ isView ? 'Linked Objects and People' : 'Set up'}}</a>
                            </li>
                            <li class="nav-item" *ngIf="hasDataAccessRequest">
                                <a class="nav-link" href="#dar" data-toggle="tab">Data access request info</a>
                            </li>
                        </ul>
                    </ng-container>
                </div>
                <div class="tab-content w-100">
                    <div class="tab-pane fade show active" id="overview">
                        <div class="col-md-12">
                            <form [formGroup]="form">
                                <div class="row form-group">
                                    <div class="col-md-3">
                                        <label for="" class="font-style text-capitalize pr-5">Status</label>
                                        <div class="d-flex">
                                            <h6 [class]="getStatusTagClasses(fv.status?.listOrder)" id="statusTag">{{fv.status?.name}}</h6>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="" class="font-style text-capitalize">organisation<sup *ngIf="!isView">*</sup></label>
                                        <ng-select [items]="organisations" bindLabel="defaultName" formControlName="organisation"
                                            [multiple]="false" [virtualScroll]="true" class="form-control ng-form-control" [compareWith]="compareIds"
                                            notFoundText="No members found" placeholder="Select Organisation" *ngIf="!isView" [searchFn]="searchOrganisations"
                                            [ngClass]="{ 'is-invalid': submitted && fc.organisation.errors }">
                                            <ng-template ng-label-tmp let-item="item">
                                                {{item.defaultName}}{{item.city ? (', ' + item.city) : ''}}{{item.countryName ? (', ' + item.countryName) : ''}}
                                            </ng-template>
                                            <ng-template ng-option-tmp let-item="item" let-search="searchTerm">
                                                <div class="row m-0">
                                                    <div class="col-md-12 p-0 m-0">{{item.defaultName}}</div>
                                                    <div class="col-md-12 p-0 m-0" style="font-size: 83%; color: gray;">{{item.city}}{{(item.city && item.countryName) ? ', ' : ''}}{{item.countryName}}</div>
                                                </div>
                                            </ng-template>
                                        </ng-select>
                                        <div class="col-md-12 invalid-feedback d-block" *ngIf="submitted && fc.organisation.errors">
                                            <p *ngIf="submitted && fc.organisation.errors.required">Please select the organisation</p>
                                        </div>
                                        <h6 *ngIf="isView" class="text-value">{{fv?.organisation?.defaultName}}</h6>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="" class="font-style text-capitalize">Display Name<sup *ngIf="!isView">*</sup></label>
                                        <input type="text" class="form-control" formControlName="displayName" *ngIf="!isView"
                                            [ngClass]="{ 'is-invalid': submitted && fc.displayName.errors }">
                                        <div class="col-md-12 invalid-feedback d-block" *ngIf="submitted && fc.displayName.errors">
                                            <p *ngIf="submitted && fc.displayName.errors.required">Please enter the Display Name</p>
                                        </div>
                                        <h6 *ngIf="isView" class="text-value">{{dupData?.displayName}}</h6>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-3">
                                        <label for="requestDecisionDate" class="font-style text-capitalize">Request decision date</label>
                                        <div class="form-group" *ngIf="!isView">
                                            <div class="input-group">
                                                <input class="form-control" placeholder="yyyy-mm-dd"
                                                    name="requestDecisionDate" ngbDatepicker #requestDecisionDate="ngbDatepicker"
                                                    [ngClass]="{ 'is-invalid': submitted && fc.requestDecisionDate.errors }"
                                                    (dateSelect)="setStatusFromForm()" (input)="setStatusFromForm()" 
                                                    formControlName="requestDecisionDate" container='body'>
                                                <div class="input-group-append">
                                                    <button class="btn btn-primary"
                                                        (click)="requestDecisionDate.toggle()" type="button">
                                                        <i class="fa fa-calendar"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <h6 class="text-value" *ngIf="isView">{{ngbDateStructToString(fv.requestDecisionDate)}}</h6>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="agreementSignedDate" class="font-style text-capitalize">Agreement signed date</label>
                                        <div class="form-group" *ngIf="!isView">
                                            <div class="input-group">
                                                <input class="form-control" placeholder="yyyy-mm-dd"
                                                    name="agreementSignedDate" ngbDatepicker #agreementSignedDate="ngbDatepicker"
                                                    [ngClass]="{ 'is-invalid': submitted && fc.agreementSignedDate.errors }"
                                                    (dateSelect)="setStatusFromForm()" (input)="setStatusFromForm()" 
                                                    formControlName="agreementSignedDate" container='body'>
                                                <div class="input-group-append">
                                                    <button class="btn btn-primary"
                                                        (click)="agreementSignedDate.toggle()" type="button">
                                                        <i class="fa fa-calendar"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <h6 class="text-value" *ngIf="isView">{{ngbDateStructToString(fv.agreementSignedDate)}}</h6>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="dataAccessAvailableFrom" class="font-style text-capitalize">Data access available from</label>
                                        <div class="form-group" *ngIf="!isView">
                                            <div class="input-group">
                                                <input class="form-control" placeholder="yyyy-mm-dd"
                                                    name="dataAccessAvailableFrom" ngbDatepicker #dataAccessAvailableFrom="ngbDatepicker"
                                                    [ngClass]="{ 'is-invalid': submitted && fc.dataAccessAvailableFrom.errors }"
                                                    (dateSelect)="setStatusFromForm()" (input)="setStatusFromForm()" 
                                                    formControlName="dataAccessAvailableFrom" container='body'>
                                                <div class="input-group-append">
                                                    <button class="btn btn-primary"
                                                        (click)="dataAccessAvailableFrom.toggle()" type="button">
                                                        <i class="fa fa-calendar"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <h6 class="text-value" *ngIf="isView">{{ngbDateStructToString(fv.dataAccessAvailableFrom)}}</h6>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="dataAccessAvailableUntil" class="font-style text-capitalize">Data access available until</label>
                                        <div class="form-group" *ngIf="!isView">
                                            <div class="input-group">
                                                <input class="form-control" placeholder="yyyy-mm-dd"
                                                    name="dataAccessAvailableUntil" ngbDatepicker #dataAccessAvailableUntil="ngbDatepicker"
                                                    [ngClass]="{ 'is-invalid': submitted && fc.dataAccessAvailableUntil.errors }"
                                                    (dateSelect)="setStatusFromForm()" (input)="setStatusFromForm()" 
                                                    formControlName="dataAccessAvailableUntil" container='body'>
                                                <div class="input-group-append">
                                                    <button class="btn btn-primary"
                                                        (click)="dataAccessAvailableUntil.toggle()" type="button">
                                                        <i class="fa fa-calendar"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <h6 class="text-value" *ngIf="isView">{{ngbDateStructToString(fv.dataAccessAvailableUntil)}}</h6>
                                    </div>
                                </div>
                                <ng-container *ngIf="isEdit || isView">
                                    <hr style="border-top: 2px solid;" />
                                    <br />
                                    <h3>Agreement Details</h3>
                                    <br />
                                    <div class="row form-group">
                                        <div class="col-md-6">
                                            <label class="form-check-label font-style" for="accessRequestsDelegatedToCrdsr">Access requests delegated to crDSR</label>
                                            <input class="form-check-input ml-4" type="checkbox" id="accessRequestsDelegatedToCrdsr"
                                                formControlName="accessRequestsDelegatedToCrdsr" *ngIf="!isView">
                                            <h6 class="text-value" *ngIf="isView">{{duaData && duaData[0]?.accessRequestsDelegatedToCrdsr ? 'Yes' : 'No'}}</h6>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="variationsFromAgreementTemplate" class="font-style">Variations from agreement template</label>
                                            <textarea cols="30" rows="3" class="form-control" id="variationsFromAgreementTemplate" 
                                                formControlName="variationsFromAgreementTemplate" *ngIf="!isView"></textarea>
                                            <h6 class="text-value" *ngIf="isView">{{duaData ? duaData[0]?.variationsFromAgreementTemplate : ''}}</h6>
                                        </div>
                                    </div>
                                    <div class="row form-group">
                                        <div class="col-md-6">
                                            <label for="filePath" class="font-style text-capitalize">Agreement link</label>
                                            <input type="text" class="form-control" id="filePath" formControlName="agreementLink" *ngIf="!isView">
                                            <a href="{{duaData ? duaData[0]?.agreementLink : '#'}}" target="_blank">
                                                <h6 class="text-value" *ngIf="isView">{{duaData ? duaData[0]?.agreementLink : ''}}</h6>
                                            </a>
                                        </div>
                                    </div>
                                    <div class="row form-group">
                                        <div class="col-md-6">
                                            <label for="reqsignatory1" class="font-style text-capitalize">Requester Signatory 1</label>
                                            <ng-select id="reqsignatory1" [items]="associatedUsers" formControlName="requesterSignatory1" [multiple]="false" 
                                                [virtualScroll]="true" class="form-control ng-form-control" [searchFn]="customSearchUsers"
                                                bindValue="id" [compareWith]="compareUsers" notFoundText="No person found" placeholder="" *ngIf="!isView">
                                                <ng-template ng-label-tmp let-item="item">
                                                    {{item.person?.firstName}} {{item.person?.lastName}}
                                                </ng-template>
                                                <ng-template ng-option-tmp let-item="item" let-search="searchTerm">
                                                    <div class="row m-0">
                                                        <div class="col-md-8 col-8 p-0 m-0">
                                                            <div class="col-md-12">{{item.person?.firstName}} {{item.person?.lastName}}</div>
                                                            <div class="col-md-12" style="font-size: 83%; color: gray;">{{item.person?.email}}</div>
                                                        </div>
                                                    </div>
                                                </ng-template>
                                            </ng-select>
                                            <h6 class="text-value" *ngIf="isView">{{duaData && duaData[0]?.requesterSignatory1?.id ? findPeopleById(duaData[0].requesterSignatory1.id) : ''}}
                                            </h6>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="reqsignatory2" class="font-style text-capitalize">Requester Signatory 2</label>
                                            <ng-select id="reqsignatory2" [items]="associatedUsers" formControlName="requesterSignatory2" [multiple]="false" 
                                                [virtualScroll]="true" class="form-control ng-form-control" [searchFn]="customSearchUsers"
                                                bindValue="id" [compareWith]="compareUsers" notFoundText="No person found" placeholder="" *ngIf="!isView">
                                                <ng-template ng-label-tmp let-item="item">
                                                    {{item.person?.firstName}} {{item.person?.lastName}}
                                                </ng-template>
                                                <ng-template ng-option-tmp let-item="item" let-search="searchTerm">
                                                    <div class="row m-0">
                                                        <div class="col-md-8 col-8 p-0 m-0">
                                                            <div class="col-md-12">{{item.person?.firstName}} {{item.person?.lastName}}</div>
                                                            <div class="col-md-12" style="font-size: 83%; color: gray;">{{item.person?.email}}</div>
                                                        </div>
                                                    </div>
                                                </ng-template>
                                            </ng-select>
                                            <h6 class="text-value" *ngIf="isView">{{duaData && duaData[0]?.requesterSignatory2?.id ? findPeopleById(duaData[0].requesterSignatory2.id) : ''}}
                                            </h6>
                                        </div>
                                    </div>
                                    <div class="row form-group">
                                        <div class="col-md-6">
                                            <label for="rsignatory1" class="font-style text-capitalize">Repository Signatory 1</label>
                                            <ng-select id="rsignatory1" [items]="associatedUsers" formControlName="repoSignatory1" [multiple]="false" 
                                                [virtualScroll]="true" class="form-control ng-form-control" [searchFn]="customSearchUsers"
                                                bindValue="id" [compareWith]="compareUsers" notFoundText="No person found" placeholder="" *ngIf="!isView">
                                                <ng-template ng-label-tmp let-item="item">
                                                    {{item.person?.firstName}} {{item.person?.lastName}}
                                                </ng-template>
                                                <ng-template ng-option-tmp let-item="item" let-search="searchTerm">
                                                    <div class="row m-0">
                                                        <div class="col-md-8 col-8 p-0 m-0">
                                                            <div class="col-md-12">{{item.person?.firstName}} {{item.person?.lastName}}</div>
                                                            <div class="col-md-12" style="font-size: 83%; color: gray;">{{item.person?.email}}</div>
                                                        </div>
                                                    </div>
                                                </ng-template>
                                            </ng-select>
                                            <h6 class="text-value" *ngIf="isView">{{duaData && duaData[0]?.repoSignatory1?.id ? findPeopleById(duaData[0].repoSignatory1.id) : ''}}
                                            </h6>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="rsignatory2" class="font-style text-capitalize">Repository Signatory 2</label>
                                            <ng-select id="rsignatory2" [items]="associatedUsers" formControlName="repoSignatory2" [multiple]="false" 
                                                [virtualScroll]="true" class="form-control ng-form-control" [searchFn]="customSearchUsers"
                                                bindValue="id" [compareWith]="compareUsers" notFoundText="No person found" placeholder="" *ngIf="!isView">
                                                <ng-template ng-label-tmp let-item="item">
                                                    {{item.person?.firstName}} {{item.person?.lastName}}
                                                </ng-template>
                                                <ng-template ng-option-tmp let-item="item" let-search="searchTerm">
                                                    <div class="row m-0">
                                                        <div class="col-md-8 col-8 p-0 m-0">
                                                            <div class="col-md-12">{{item.person?.firstName}} {{item.person?.lastName}}</div>
                                                            <div class="col-md-12" style="font-size: 83%; color: gray;">{{item.person?.email}}</div>
                                                        </div>
                                                    </div>
                                                </ng-template>
                                            </ng-select>
                                            <h6 class="text-value" *ngIf="isView">{{duaData && duaData[0]?.repoSignatory2?.id ? findPeopleById(duaData[0].repoSignatory2.id) : ''}}
                                            </h6>
                                        </div>
                                    </div>
                                    <div class="row form-group">
                                        <div class="col-md-6">
                                            <label for="psignatory1" class="font-style text-capitalize">Provider Signatory 1</label>
                                            <ng-select id="psignatory1" [items]="associatedUsers" formControlName="providerSignatory1" [multiple]="false" 
                                                [virtualScroll]="true" class="form-control ng-form-control" [searchFn]="customSearchUsers"
                                                bindValue="id" [compareWith]="compareUsers" notFoundText="No person found" placeholder="" *ngIf="!isView">
                                                <ng-template ng-label-tmp let-item="item">
                                                    {{item.person?.firstName}} {{item.person?.lastName}}
                                                </ng-template>
                                                <ng-template ng-option-tmp let-item="item" let-search="searchTerm">
                                                    <div class="row m-0">
                                                        <div class="col-md-8 col-8 p-0 m-0">
                                                            <div class="col-md-12">{{item.person?.firstName}} {{item.person?.lastName}}</div>
                                                            <div class="col-md-12" style="font-size: 83%; color: gray;">{{item.person?.email}}</div>
                                                        </div>
                                                    </div>
                                                </ng-template>
                                            </ng-select>
                                            <h6 class="text-value" *ngIf="isView">{{duaData && duaData[0]?.providerSignatory1?.id ? findPeopleById(duaData[0].providerSignatory1.id) : ''}}
                                            </h6>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="psignatory2" class="font-style text-capitalize">Provider Signatory 2</label>
                                            <ng-select id="psignatory2" [items]="associatedUsers" formControlName="providerSignatory2" [multiple]="false" 
                                                [virtualScroll]="true" class="form-control ng-form-control" [searchFn]="customSearchUsers"
                                                bindValue="id" [compareWith]="compareUsers" notFoundText="No person found" placeholder="" *ngIf="!isView">
                                                <ng-template ng-label-tmp let-item="item">
                                                    {{item.person?.firstName}} {{item.person?.lastName}}
                                                </ng-template>
                                                <ng-template ng-option-tmp let-item="item" let-search="searchTerm">
                                                    <div class="row m-0">
                                                        <div class="col-md-8 col-8 p-0 m-0">
                                                            <div class="col-md-12">{{item.person?.firstName}} {{item.person?.lastName}}</div>
                                                            <div class="col-md-12" style="font-size: 83%; color: gray;">{{item.person?.email}}</div>
                                                        </div>
                                                    </div>
                                                </ng-template>
                                            </ng-select>
                                            <h6 class="text-value" *ngIf="isView">{{duaData && duaData[0]?.providerSignatory2?.id ? findPeopleById(duaData[0].providerSignatory2.id) : ''}}
                                            </h6>
                                        </div>
                                    </div>
                                </ng-container>
                                <ng-container *ngIf="isEdit || isView">
                                    <hr style="border-top: 2px solid;" />
                                    <h3>Notes</h3>
                                    <div formArrayName="notes">
                                        <div class="row form-group">
                                            <div class="col-md-12 text-right pb-2">
                                                <button class="btn btn-primary p-2" (click)="addDupNote()" *ngIf="!isView"><i class="fa fa-plus p-0"></i></button>
                                            </div>
                                            <div class="col-md-12" *ngFor="let note of notes().controls;let i = index" [formGroupName]="i">
                                                <div class="card border-0">
                                                    <div class="card-body pl-0 pr-0 pb-0 pt-5">
                                                        <i class="fa fa-times float-right pr-1 text-danger" style="cursor: pointer;"
                                                            (click)="deleteDupNote(i)" *ngIf="!isView"></i>
                                                        <i class="fa fa-check float-right pr-2 text-success" style="cursor: pointer;"
                                                            (click)="saveDupNote(note)" *ngIf="!isView"></i>
                                                        <h6>{{(note.value.author?.firstName || note.value.author?.lastName ? 
                                                            (note.value.author?.firstName ? note.value.author.firstName + ' ' : '') 
                                                            + (note.value.author?.lastName ? note.value.author.lastName : '') : 'Missing author')}} <small>{{note.value.createdOn}}</small></h6>
                                                        <textarea id="notes" cols="30" rows="3" class="form-control" formControlName="text"
                                                            *ngIf="!isView"></textarea>
                                                        <span class="text-value" *ngIf="isView">{{note.value.text}}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </ng-container>
                            </form>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="setup">
                        <div class="col-md-12">
                            <div class="row form-group">
                                <div class="col-md-12">
                                    <span class="font-style">Associated Studies</span>
                                    <button class="btn btn-primary float-right" (click)="addStudy()" *ngIf="!isView">Add
                                        Study</button>
                                    <ng-container *ngIf="associatedStudies.length <= 0">
                                        <p>No Associated Study</p>
                                    </ng-container>
                                    <ng-container *ngIf="associatedStudies.length > 0">
                                        <ul>
                                            <li *ngFor="let study of associatedStudies; let i = index" class="pl-4">
                                                <a [routerLink]="['/studies', study.study?.sdSid, 'view']">
                                                    {{study.study?.sdSid}}
                                                </a>
                                                <span title="{{study.study?.displayTitle}}">({{(study.study?.displayTitle && study.study?.displayTitle.length <= sliceLength) ? study.study?.displayTitle : (study.study?.displayTitle | slice:0:sliceLength) + '...'}})</span>
                                                <i class="fa fa-times pl-3" (click)="removeDupStudy(study)"
                                                    *ngIf="!isView"></i>
                                            </li>
                                        </ul>
                                    </ng-container>
    
                                    <hr>
                                    <span class="font-style">Associated Data Objects</span>
                                    <button class="btn btn-primary float-right" (click)="addDataObject()"
                                        *ngIf="!isView" [disabled]="addDOButtonDisabled">Add Data Objects</button>
                                    <ng-container *ngIf="associatedObjects.length <= 0">
                                        <p>No Associated Data Object</p>
                                    </ng-container>
                                    <ng-container *ngIf="associatedObjects.length > 0">
                                        <ul>
                                            <li *ngFor="let object of associatedObjects; let i = index" class="pl-2 pt-5">
                                                <a [routerLink]="['/data-objects', object.dataObject?.sdOid, 'view']">
                                                    {{object.dataObject?.sdOid}} -
                                                </a>
                                                <span class="associated-do-title" title="{{object.dataObject?.displayTitle}}">{{(object.dataObject?.displayTitle && object.dataObject?.displayTitle.length <= sliceLength) ? object.dataObject?.displayTitle : (object.dataObject?.displayTitle | slice:0:sliceLength) + '...'}}</span>
                                                <i class="fa fa-times pl-3" (click)="removeDupObject(object.id)"
                                                    *ngIf="!isView"></i>
    
                                                <!-- DO Instances -->
                                                <ul style="list-style-type: circle;">
                                                    <li class="li-subtitle pt-1">Data object instances</li>
                                                    <ng-container *ngIf="associatedObjects[i]?.dataObject?.objectInstances?.length > 0; else noInstances">
                                                        <ul style="list-style-type: square;">
                                                            <li *ngFor="let instance of associatedObjects[i]?.dataObject?.objectInstances" class="dup-associated-do-li">
                                                                {{instance.sdIid ? instance.sdIid : '\<No instance ID\>'}}: 
                                                                {{instance.title ? instance.title : '\<No title\>'}} ({{instance.resourceType?.name ? instance.resourceType?.name : '\<No resource type defined\>'}})
                                                                <!-- <ng-container *ngIf="checkUrl(instance.url); else notUploaded">
                                                                    <ng-container *ngIf="isView; else notView">
                                                                        <ng-container *ngIf="lastCompletedStep >= 2; else missingSteps">
                                                                            <ng-container *ngIf="canAccess(); else unauthorized">
                                                                                <span class="pl-2" title="Data upload to the TSD Repository">
                                                                                    <a class="btn btn-sm btn-success" target="_blank" href="{{instance.url}}">Access data</a>
                                                                                </span>
                                                                            </ng-container>
                                                                            <ng-template #unauthorized>
                                                                                <span class="pl-2" title="You have to be part of the associated people (below) of the DUP to be able to get access to the data">
                                                                                    <button class="btn btn-sm btn-secondary" disabled>Access data</button>
                                                                                </span>
                                                                            </ng-template>
                                                                        </ng-container>
                                                                        <ng-template #missingSteps>
                                                                            <span class="pl-2" title="DUP step should be at 'Availability of the data' to be able to access the data">
                                                                                <button class="btn btn-sm btn-secondary" disabled>Access data</button>
                                                                            </span>
                                                                        </ng-template>
                                                                    </ng-container>
                                                                    <ng-template #notView>
                                                                        <span class="pl-2" title="Data access is not enabled when editing the DUP">
                                                                            <button class="btn btn-sm btn-secondary" disabled>Access data</button>
                                                                        </span>
                                                                    </ng-template>
                                                                </ng-container>
                                                                <ng-template #notUploaded>
                                                                    <span class="pl-2" title="Data needs to be uploaded to TSD before accessing it">
                                                                        <button class="btn btn-sm btn-secondary" disabled>Data not uploaded</button>
                                                                    </span>
                                                                </ng-template> -->
                                                            </li>
                                                        </ul>
                                                    </ng-container>
                                                    <ng-template #noInstances>
                                                        <ul style="list-style-type: none;">
                                                            <li style="font-style:italic" class="dup-associated-do-li">There are no instances related to the data object, please create at least one before uploading and requesting access
                                                                <span class="pl-2">
                                                                    <a [routerLink]="['/data-objects', object.dataObject?.sdOid, 'edit']" style="font-style:normal" class="btn btn-success btn-sm">Go to data object</a>
                                                                </span>
                                                            </li>
                                                        </ul>
                                                    </ng-template>
                                                    <!-- Prereqs-->
                                                    <li class="li-subtitle">Access prerequisites</li>
                                                    <ng-container *ngIf="prereqs[i]?.length > 0">
                                                        <ul style="list-style-type: square;">
                                                            <li *ngFor="let prereq of prereqs[i]">
                                                                {{prereq.prereqType?.name ? prereq.prereqType.name : 'Unknown prerequisite type'}}
                                                                <span title="{{prereq.prereqNotes}}">: {{(prereq.prereqNotes?.length > sliceLength) ? ((prereq.prereqNotes | slice:0:sliceLength) + '...'): (prereq.prereqNotes)}}</span>
                                                            </li>
                                                        </ul>
                                                    </ng-container>
                                                </ul>
    
                                            </li>
                                        </ul>
                                    </ng-container>
                                    <hr>
                                    <span class="font-style">Associated People</span>
                                    <button class="btn btn-primary float-right" (click)="addUser()" *ngIf="!isView">Add
                                        People</button>
                                    <ng-container *ngIf="associatedUsers.length <= 0">
                                        <p>No Associated Users</p>
                                    </ng-container>
                                    <ng-container *ngIf="associatedUsers.length > 0">
                                        <ul>
                                            <li *ngFor="let user of associatedUsers; let i = index" class="pl-4">
                                                <ng-container *ngIf="isManager; else displayUserInfo">
                                                    <a [routerLink]="['/people', user.person?.id, 'view']">
                                                        {{user.person?.firstName}} {{user.person?.lastName}}
                                                    </a> ({{user.person?.email}})
                                                    <i class="fa fa-times pl-3" (click)="removeDupUser(user.id)"
                                                        *ngIf="!isView"></i>
                                                </ng-container>
                                                <ng-template #displayUserInfo>{{user.person?.firstName}} {{user.person?.lastName}} ({{user.person?.email}})
                                                </ng-template>
                                            </li>
                                        </ul>
                                    </ng-container>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="dar">
                        <div class="col-md-12">
                            <ng-container *ngTemplateOutlet="darView"></ng-container>
                        </div>
                    </div>
                </div>
            </div>
        </ng-template>
    </div>
</div>